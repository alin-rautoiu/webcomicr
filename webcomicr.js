var series = [
    {
        'id': '1',
        'name': 'Cum ar fi...',
        'episodes': [
            {
                'id': '1',
                'row': '2',
                'columns': '4',
                'name': 'Ep 1',
                'images': [
                    {
                        'id': '1',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_1.jpeg'
                    },
                    {
                        'id': '2',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_2.jpeg'
                    },
                    {
                        'id': '3',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_3.jpeg'
                    },
                    {
                        'id': '4',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_4.jpeg'
                    },
                    {
                        'id': '5',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_5.jpeg'
                    },
                    {
                        'id': '6',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_6.jpeg'
                    },
                    {
                        'id': '7',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_7.jpeg'
                    },
                    {
                        'id': '8',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/01/1_8.jpeg'
                    }
                ]
            },
            {
                'id': '2',
                'row': '2',
                'columns': '4',
                'name': 'Ep 2',
                'images': [
                    {
                        'id': '1',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_1.jpeg'
                    },
                    {
                        'id': '2',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_2.jpeg'
                    },
                    {
                        'id': '3',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_3.jpeg'
                    },
                    {
                        'id': '4',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_4.jpeg'
                    },
                    {
                        'id': '5',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_5.jpeg'
                    },
                    {
                        'id': '6',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_6.jpeg'
                    },
                    {
                        'id': '7',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_7.jpeg'
                    },
                    {
                        'id': '8',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/02/2_8.jpeg'
                    }
                ]
            },
            {
                'id': '3',
                'row': '2',
                'columns': '4',
                'name': 'Ep 3',
                'images': [
                    {
                        'id': '1',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_1.jpeg'
                    },
                    {
                        'id': '2',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_2.jpeg'
                    },
                    {
                        'id': '3',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_3.jpeg'
                    },
                    {
                        'id': '4',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_4.jpeg'
                    },
                    {
                        'id': '5',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_5.jpeg'
                    },
                    {
                        'id': '6',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_6.jpeg'
                    },
                    {
                        'id': '7',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_7.jpeg'
                    },
                    {
                        'id': '8',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/cum ar fi/03/3_8.jpeg'
                    }
                ]
            }
        ]
    },
    {
        'id': '2',
        'name': 'Olvlildliu Herman, explorator',
        'episodes': [
            {
                'id': '4',
                'row': '4',
                'columns': '3',
                'name': 'Ep 1',
                'images': [
                    {
                        'id': '1',
                        'colspan': '3',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/01.png'
                    },
                    {
                        'id': '2',
                        'colspan': '3',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/02.png'
                    },
                    {
                        'id': '3',
                        'colspan': '2',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/03.png'
                    },
                    {
                        'id': '4',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/04.png'
                    },
                    {
                        'id': '5',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/05.jpg'
                    },
                    {
                        'id': '6',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/06.jpg'
                    },
                    {
                        'id': '7',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/07.jpg'
                    },
                    {
                        'id': '8',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/08.jpg'
                    },
                    {
                        'id': '9',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/09.jpg'
                    },
                    {
                        'id': '10',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/10.jpg'
                    },
                    {
                        'id': '11',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/11.jpg'
                    },
                    {
                        'id': '12',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/12.jpg'
                    },
                    {
                        'id': '13',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/13.jpg'
                    },
                    {
                        'id': '14',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/14.jpg'
                    },
                    {
                        'id': '15',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/15.jpg'
                    },
                    {
                        'id': '16',
                        'colspan': '1',
                        'path': 'https://raw.githubusercontent.com/alin-rautoiu/webcomicr/master/issues/Olvildliu/01/16.jpg'
                    }
                ]                    
            }
        ]

    }
]

var express = require('express');
var path = require('path');
var fs = require('fs');
var pg = require('pg');
var app = express();


var dbURL = process.env.DATABASE_URL || 'postgres://jrtfbkxfelyvvm:D-CfjK6MW-OeK2AXnlkBLQtH3O@ec2-23-21-219-12.compute-1.amazonaws.com:5432/d8ppu14gbaacn0';

app.get('/db', function (request, response) {
    console.log(dbURL);
  pg.connect(dbURL, function(err, client, done) {
    client.query('SELECT * FROM test_table', function(err, result) {
      done();
      if (err)
       { console.error(err); response.send("Error " + err); }
      else
       { response.render('pages/db', {results: result.rows} ); }
    });
  });
});

function buildEpisodesList(theSeries) {
    var thumbnails = [];    
    thumbnails['series_name'] = theSeries.name;

    for (var j = 0; j < theSeries.episodes.length; j++) {
        var thumbnail = {};

        thumbnail['id'] = theSeries.episodes[j].id;
        thumbnail['name'] = theSeries.episodes[j].name;
        thumbnail['thumbnail'] = theSeries.episodes[j].images[0].path;

        thumbnails.push(thumbnail);
    }

    return thumbnails;
}

function buildSeriesList() {
    var thumbnails = [];    
    
    for (var i = 0; i < series.length; i++) {
        var thumbnail = {};

        thumbnail['id'] = series[i].id;
        thumbnail['name'] = series[i].name;
        thumbnail['thumbnail'] = series[i].episodes[0].images[0].path;

        thumbnails.push(thumbnail);
    }

    return thumbnails;
}

function getSeriesById(id) {
    for (var i = 0; i < series.length; i++) {
        if (series[i].id == id) {
            return series[i];
        }
    }
}

function getEpisodeById(seriesId, episodeId) {
    var episodes = getSeriesById(seriesId).episodes;

    for (var i = 0; i < episodes.length; i++) {
        if (episodes[i].id == episodeId) {
            return episodes[i];
        }
    }
}

app.engine('html', require('ejs').renderFile);


app.get('/', function(req, res) {
    res.render('index.html');
});

app.get('/getSeries/:id', function(req, res) {
    var id = req.params.id;

    var theSeries = getSeriesById(id);
    if (theSeries == null) {
        res.send("No such series!");
        return;  
    }

    res.setHeader('Content-Type', 'application/json');
    res.send(JSON.stringify(theSeries));
    return;        
});

app.get('/getEpisode/', function(req, res) {
    var episodeId = req.query.episodeId;
    var seriesId = req.query.seriesId;

    console.log(episodeId);
    console.log(seriesId);

    var theEpisode = getEpisodeById(seriesId, episodeId);
    if (theEpisode == null) {
        res.send("No such episode!");
        return;  
    }

    res.setHeader('Content-Type', 'application/json');
    res.send(JSON.stringify(theEpisode));
    return;        
});

app.get('/getEpisodesList/:seriesId', function(req, res) {
    var seriesId = req.params.seriesId;
   
    var theSeries = getSeriesById(seriesId);
    if (theSeries == null) {
        res.send("No such series!");
        return;  
    }

    var episodeList = buildEpisodesList(theSeries);
    res.setHeader('Content-Type', 'application/json');
    res.send(JSON.stringify(episodeList));
    return;      
});

app.get('/getSeriesList/', function(req, res) {   
    var episodeList = buildSeriesList();

    res.setHeader('Content-Type', 'application/json');
    res.send(JSON.stringify(episodeList));
    return;
});


var server = app.listen(process.env.PORT || 3002);

